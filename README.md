# AutoCAD_Block_Change

## Version 3.2 - 智能聚合線處理
已升級圖塊批量編輯工具，新增智能聚合線延伸/裁剪功能，解決聚合線穿透圖塊問題

### 主要功能
- **批量修改圖塊名稱** - 支援圖層篩選
- **批量更換圖塊定義** - 支援圖層篩選、旋轉記憶、智能聚合線處理
- **輸出圖面圖塊名稱** - 包含圖層分佈、旋轉角度、聚合線連接資訊
- **CSV 匯入/匯出** - 支援批量資料處理
- **圖層篩選** - 可選擇特定圖層進行操作
- **智能聚合線處理** - 自動處理圖塊與聚合線的連接關係，避免穿透問題

### 新增功能 (v3.2)
#### ?? 智能聚合線延伸/裁剪系統
- **邊界檢測技術** - 自動識別新圖塊的實際幾何邊界
- **防穿透保護** - 智能檢測聚合線是否會插入圖塊內部
- **AutoCAD EXTEND/TRIM邏輯**：
  - **智能延伸 (EXTEND)**：當聚合線不與圖塊相交時，延伸到理想位置
  - **智能裁剪 (TRIM)**：當聚合線與圖塊相交時，自動裁剪到邊界交點
- **正交延伸保持** - 確保聚合線延伸後保持水平或垂直特性
- **一對一圖塊對應** - 每個舊圖塊的聚合線都對應到新圖塊位置
- **多類型聚合線支援** - 支援 Polyline 和 Polyline2d
- **容錯恢復機制** - 智能處理失敗時自動回退到簡單延伸

#### ?? 旋轉記憶功能
- **保持圖塊旋轉角度** - 新圖塊自動使用舊圖塊的旋轉角度
- **可選擇性旋轉** - 用戶可選擇是否保持旋轉角度
- **完整變換保持** - 保持位置、旋轉、縮放比例
- **靈活旋轉控制** - 可重置旋轉角度為0度
- **額外旋轉功能** - 支援額外的左右旋轉

### 使用說明 (v3.2)

#### 智能聚合線延伸/裁剪功能
1. **啟用功能**：勾選「智能聚合線延伸/裁剪」
2. **自動處理**：系統會自動：
   - 檢測與舊圖塊連接的聚合線端點
   - 計算新圖塊的邊界範圍
   - 判斷是否需要延伸或裁剪
   - 執行正交延伸或邊界裁剪
3. **處理邏輯**：
   - **延伸模式**：聚合線不與新圖塊相交時，延伸到最佳位置
   - **裁剪模式**：聚合線會穿透新圖塊時，裁剪到邊界交點

#### 旋轉記憶功能
1. **啟用功能**：勾選「保持圖塊旋轉角度」（預設啟用）
2. **執行置換**：新圖塊將自動使用相同的旋轉角度
3. **額外旋轉**：可選擇額外的左右旋轉功能

### 技術特點 (v3.2)
#### ?? 智能邊界處理
- **精確邊界計算**：使用 AutoCAD GeometricExtents API 獲取圖塊實際邊界
- **緩衝區設計**：添加 0.1 單位緩衝避免聚合線緊貼邊界
- **四邊界檢測**：檢查聚合線與圖塊四個邊界的交點計算
- **最近交點選擇**：自動選擇距離聚合線起點最近的交點

#### ?? 正交延伸算法
- **方向向量計算**：精確計算聚合線在端點的方向向量
- **正交投影技術**：基於向量數學的正交投影計算
- **智能方向選擇**：自動選擇沿線或垂直方向中較大投影的方向

#### ??? 容錯與穩定性
- **異常處理機制**：完整的 try-catch 錯誤處理
- **回退邏輯**：智能處理失敗時自動使用簡單延伸
- **事務完整性**：完整的 AutoCAD 事務處理確保操作原子性

### 圖層篩選功能 (v2.0.0)
#### ?? 圖層篩選功能
- **多選圖層下拉選單** - 可選擇一個或多個圖層
- **按圖層篩選置換** - 只對選定圖層中的圖塊進行置換
- **按圖層篩選重命名** - 只對選定圖層中有參照的圖塊進行重命名
- **自動圖層載入** - 自動讀取當前圖紙的所有圖層
- **圖層刷新功能** - 可手動刷新圖層清單

#### ?? 使用說明
1. **啟用圖層篩選**：勾選「按圖層篩選」選項
2. **選擇圖層**：在圖層清單中勾選要處理的圖層
3. **執行操作**：只有在選定圖層中的圖塊會被處理
4. **未選定圖層**：不會進行任何變更

#### ? 功能特點
- **智能篩選**：只對符合條件的圖塊進行操作
- **保持圖層**：置換後的圖塊保持原始圖層設定
- **圖層統計**：輸出CSV時包含各圖層的圖塊分佈統計
- **容錯設計**：未啟用篩選時對所有圖塊操作（向後相容）

### 指令
- `BLOCKTOOL` - 開啟圖塊管理工具
- `BT` - 快速開啟工具
- `圖塊工具` - 中文指令

### 技術規格
- 目標框架：.NET 8
- AutoCAD API：AutoCAD.NET
- 資料格式：CSV (UTF-8編碼)
- 圖層支援：完整圖層篩選功能
- 幾何運算：3D點距離計算、線段投影、邊界交點計算
- 聚合線支援：Polyline、Polyline2d
- 邊界檢測：GeometricExtents + 線段交點算法

### 應用場景 (v3.2)
#### ??? 建築設計應用
- **門窗圖塊更新**：更換門窗圖塊，聚合線自動裁剪到門框邊界，不會穿透圖塊
- **牆線連接處理**：牆線自動延伸或裁剪到新圖塊邊界，保持建築完整性
- **標準化門窗**：批量統一門窗規格，自動處理所有牆線連接

#### ?? 工程系統應用
- **管線系統升級**：更新管件圖塊，管線自動裁剪避免穿透設備
- **設備替換**：更換設備圖塊，連接線智能延伸或裁剪到設備邊界
- **標準化設備**：批量統一設備規格，保持所有連接線的正確性

#### ?? 設計標準化
- **圖塊標準化作業**：批量統一圖塊規格並智能處理所有連接關係
- **圖面清理**：自動處理圖塊更換後的線條延伸和裁剪問題
- **品質控制**：確保圖塊替換後的圖面品質和完整性

### 版本歷史
- **v3.2 (最新)**：智能聚合線延伸/裁剪系統，解決聚合線穿透問題
- **v3.1**：新增額外旋轉功能，增強旋轉控制
- **v3.0**：旋轉記憶與聚合線黏附功能
- **v2.0**：圖層篩選功能
- **v1.0**：基礎圖塊批量處理功能
